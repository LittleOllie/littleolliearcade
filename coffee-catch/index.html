<!DOCTYPE html>
<html lang="en">
<head>

<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  base-uri 'self';
  object-src 'none';
  frame-ancestors 'none';
  img-src 'self' data:;
  style-src 'self' 'unsafe-inline';
  script-src 'self' https://www.gstatic.com https://www.googleapis.com 'unsafe-inline';
  connect-src 'self' https://firestore.googleapis.com https://www.googleapis.com;
  upgrade-insecure-requests;
">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Little Ollie Coffee Catch</title>

<style>
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  :root{
    --bg1:#6de0ff;
    --bg2:#4c6fff;

    --panel: rgba(0,0,0,.18);
    --panel2: rgba(0,0,0,.22);
    --shadow: 0 14px 34px rgba(0,0,0,.35);

    --btnYellow:#ffdd55;
    --btnYellow2:#ffd22e;
    --btnText:#222;
    --btnShadow: 0 10px 20px rgba(0,0,0,.22);

    --text:#fff;
    --radius: 18px;
    --gap: 10px;

    --gold: rgba(255,215,0,.22);
    --silver: rgba(192,192,192,.18);
    --bronze: rgba(205,127,50,.18);
  }

  body{
    margin:0;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:18px 10px 46px;
    background: radial-gradient(circle at top, var(--bg1), var(--bg2));
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    color: var(--text);
  }

  .wrap{
    width: 1120px;
    max-width: 96vw;
    background: var(--panel);
    border-radius: 20px;
    padding: 14px;
    box-shadow: var(--shadow);
  }

  .header{
    width:100%;
    display:block;
    border-radius: 14px;
    margin-bottom: 12px;
    box-shadow: 0 10px 24px rgba(0,0,0,.25);
  }

  .topbar{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    margin-bottom: 12px;
  }

  .controls{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
  }

  button, input{
    border:none;
    border-radius: 12px;
    padding: 10px 12px;
    font-weight: 900;
    font-size: 14px;
    outline:none;
  }

  input{
    background: rgba(255,255,255,.92);
    color:#111;
    min-width: 180px;
  }

  button{
    cursor:pointer;
    color: var(--btnText);
    background: var(--btnYellow);
    box-shadow: var(--btnShadow);
    transition: transform .06s ease, filter .15s ease;
  }
  button:hover{ filter: brightness(1.03); }
  button:active{ transform: scale(.98); }
  button:disabled{ opacity:.6; cursor:not-allowed; }

  .stats{
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
    font-weight: 900;
  }
  .pill{
    background: rgba(0,0,0,.22);
    padding: 8px 10px;
    border-radius: 14px;
    box-shadow: 0 10px 18px rgba(0,0,0,.18);
  }

  .main{
    display:grid;
    grid-template-columns: 1fr 320px;
    gap: 14px;
    align-items:start;
  }
  @media (max-width: 920px){
    .main{ grid-template-columns: 1fr; }
  }

  .gameCard{
    background: rgba(0,0,0,.18);
    border-radius: 18px;
    padding: 12px;
    box-shadow: 0 12px 26px rgba(0,0,0,.25);
  }

  .stage{
    width:100%;
    aspect-ratio: 1 / 1;     /* ‚úÖ square play area */
    max-height: 72vh;
    border-radius: 16px;
    background: rgba(255,255,255,.10);
    overflow:hidden;
    position:relative;
    box-shadow: 0 10px 20px rgba(0,0,0,.18);
    touch-action: none;
  }

  canvas{ width:100%; height:100%; display:block; }

  .sideCard{
    background: rgba(0,0,0,.18);
    border-radius: 18px;
    padding: 12px;
    box-shadow: 0 12px 26px rgba(0,0,0,.25);
  }
  .sideTitle{
    font-weight: 950;
    font-size: 16px;
    margin: 0 0 8px;
  }
  .hint{
    font-size: 13px;
    opacity: .95;
    line-height: 1.35;
    margin-bottom: 10px;
    font-weight: 800;
  }
  .muted{ opacity:.9; font-weight:900; }

  .overlay{
    position: fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,.55);
    z-index: 50;
    padding: 14px;
  }
  .modal{
    width: 560px;
    max-width: 95vw;
    background: rgba(20,20,28,.96);
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.5);
    position: relative;
    overflow:hidden;
  }
  .modal h2{ margin: 0 0 6px; font-size: 20px; }
  .modal p{
    margin: 0 0 10px;
    opacity: .95;
    line-height: 1.3;
    font-weight: 800;
  }
  .modal .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 8px;
    align-items:center;
  }

  .leaderboard{
    margin-top: 10px;
    border-radius: 14px;
    overflow:hidden;
    background: rgba(255,255,255,.10);
  }
  .lbRow{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding: 8px 10px;
    font-weight: 900;
    border-bottom: 1px solid rgba(255,255,255,.10);
    font-size: 13px;
  }
  .lbRow:last-child{ border-bottom:none; }
  .lbRow.top1{ background: var(--gold); }
  .lbRow.top2{ background: var(--silver); }
  .lbRow.top3{ background: var(--bronze); }
  .lbDivider{
    height: 1px;
    background: rgba(255,255,255,.18);
    margin: 6px 0;
    border-radius: 999px;
  }

  #confettiCanvas{
    position: fixed;
    inset:0;
    pointer-events:none;
    z-index: 60;
    display:none;
  }

  .lo-footer{
    text-align:center;
    margin-top: 14px;
    padding: 10px 8px;
    font-weight: 900;
    font-size: 12px;
    letter-spacing: .2px;
    opacity: .92;
  }
  .lo-footer a{
    color: rgba(255,255,255,.95);
    text-decoration: none;
    border-bottom: 1px dashed rgba(255,255,255,.45);
    padding-bottom: 2px;
  }
  .lo-footer a:hover{
    opacity: 1;
    border-bottom-color: rgba(255,255,255,.85);
  }
</style>

<link rel="stylesheet" href="../ui/lo-arcade-kit.css">
<script defer src="../ui/lo-arcade-kit.js"></script>
</head>

<body>
  <canvas id="confettiCanvas"></canvas>

  <div class="wrap">
    <img class="header" src="header.png" alt="Header" />

    <div class="topbar">
      <div class="controls">
        <button id="menuBtn">üïπÔ∏è Arcade Menu</button>
        <button id="startBtn">‚ñ∂Ô∏è Start</button>
        <button id="pauseBtn" disabled>‚è∏Ô∏è Pause</button>
        <button id="resetBtn">‚Ü©Ô∏è Reset</button>
        <button id="leaderboardBtn">üèÜ Leaderboard</button>
      </div>

      <div class="stats">
        <div class="pill">‚òï Caught: <span id="caught">0</span></div>
        <div class="pill">‚≠ê Score: <span id="score">0</span></div>
        <div class="pill">üìà Level: <span id="level">0</span></div>
        <div class="pill">‚ù§Ô∏è Lives: <span id="lives">3</span></div>
        <div class="pill">‚è±Ô∏è Time: <span id="time">0:00</span></div>
        <div class="pill">‚ú® Effect: <span id="effect">‚Äî</span></div>
      </div>
    </div>

    <div class="main">
      <div class="gameCard">
        <div class="stage" id="stage">
          <canvas id="game"></canvas>
        </div>

        <div class="lo-footer">
          ‚ö° Powered by <a href="#" onclick="return false;">Little Ollie Studio</a>
        </div>
      </div>

      <div class="sideCard">
        <p class="sideTitle">üìñ How to play</p>
        <div class="hint">
          Move the coffee bag left/right to catch falling beans.<br/>
          The game starts slow‚Ä¶ then speeds up <b>every 10 caught</b>.
        </div>

        <div class="hint">
          <span class="muted">Beans:</span><br/>
          üü§ Brown = +1 score<br/>
          üü° Gold = +5 score<br/>
          üîµ Blue = Chill (slow motion)<br/>
          üî¥ Red = Rush (faster + smaller bag)
        </div>

        <div class="hint">
          <span class="muted">Controls:</span><br/>
          ‚Ä¢ Drag anywhere on the game (mobile/tablet)<br/>
          ‚Ä¢ Mouse move (desktop)<br/>
          ‚Ä¢ Arrow keys / A-D (desktop)
        </div>

        <div class="hint" style="margin-top:10px;">
          <span class="muted">Assets we‚Äôll use:</span><br/>
          ‚Ä¢ <b>coffee_bg.png</b> (background)<br/>
          ‚Ä¢ <b>bag1.png</b> (bag image)
        </div>
      </div>
    </div>
  </div>

  <!-- Game Over overlay -->
  <div class="overlay" id="gameOverOverlay">
    <div class="modal">
      <h2>üòµ Game Over</h2>
      <p>
        You caught <b><span id="goCaught"></span></b> beans and scored <b><span id="goScore"></span></b> in <b><span id="goTime"></span></b>.
      </p>

      <div class="row">
        <input id="playerName" type="text" maxlength="20" placeholder="‚úçÔ∏è Name (leaderboard)" />
        <button id="submitScoreBtn">‚úÖ Submit Score</button>
        <button id="closeGoBtn">‚ùå Close</button>
      </div>

      <p class="hint" id="submitHint" style="margin-top:8px; opacity:.92;"></p>

      <div class="leaderboard" id="goLbList" style="margin-top:12px;"></div>

      <div class="hint" style="margin-top:10px; opacity:.9;">
        Ranking: highest score, then longest time.
      </div>
    </div>
  </div>

  <!-- Leaderboard overlay -->
  <div class="overlay" id="lbOverlay">
    <div class="modal">
      <h2>üèÜ Leaderboard</h2>

      <div class="row" style="margin-top:0;">
        <button id="lbRefreshBtn">üîÑ Refresh</button>
        <button id="lbCloseBtn">‚ùå Close</button>
      </div>

      <div class="leaderboard" id="lbList" style="margin-top:12px;"></div>

      <div class="hint" style="margin-top:10px; opacity:.9;">
        Ranking: highest score, then longest time.
      </div>
    </div>
  </div>

<script type="module">
  // -----------------------------
  // Firebase (paste your config)
  // -----------------------------
  const firebaseConfig = {
    apiKey: "PASTE_API_KEY",
    authDomain: "PASTE_AUTH_DOMAIN",
    projectId: "PASTE_PROJECT_ID",
    storageBucket: "PASTE_STORAGE_BUCKET",
    messagingSenderId: "PASTE_SENDER_ID",
    appId: "PASTE_APP_ID"
  };

  const CONFIG_PRESENT =
    !!firebaseConfig?.apiKey &&
    !!firebaseConfig?.projectId &&
    !String(firebaseConfig.apiKey).toUpperCase().includes("PASTE");

  let firebaseOk = false;
  let db = null, collection, getDocs, limit, orderBy, query, serverTimestamp, doc, setDoc;

  if (CONFIG_PRESENT) {
    try {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
      const firestore = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");
      ({ collection, getDocs, limit, orderBy, query, serverTimestamp, doc, setDoc } = firestore);

      const app = initializeApp(firebaseConfig);
      db = firestore.getFirestore(app);
      firebaseOk = true;
    } catch (e) {
      console.error("Firebase failed to load/init:", e);
      firebaseOk = false;
    }
  }

  // -----------------------------
  // Shared player name (no prompting)
  // -----------------------------
  const LS_PLAYER_NAME = "lo_player_name_v1";
  const LS_PLAYER_ID   = "lo_player_id_v1";

  function makeId(){
    if (crypto?.randomUUID) return crypto.randomUUID();
    return "p_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  }
  function getPlayer(){
    const name = (localStorage.getItem(LS_PLAYER_NAME) || "").trim().slice(0,20);
    let id = (localStorage.getItem(LS_PLAYER_ID) || "").trim();
    if (!id){
      id = makeId();
      localStorage.setItem(LS_PLAYER_ID, id);
    }
    return { name: name || "Anon", rawName: name, id, isAnon: !name };
  }
  function setPlayerName(name){
    const clean = String(name || "").trim().slice(0,20);
    if (!clean) return false;
    if (clean.toLowerCase() === "anon" || clean.toLowerCase() === "anonymous") return false;
    localStorage.setItem(LS_PLAYER_NAME, clean);
    return true;
  }

  // -----------------------------
  // DOM
  // -----------------------------
  const menuBtn = document.getElementById("menuBtn");
  const startBtn = document.getElementById("startBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const resetBtn = document.getElementById("resetBtn");
  const leaderboardBtn = document.getElementById("leaderboardBtn");

  const caughtEl = document.getElementById("caught");
  const scoreEl = document.getElementById("score");
  const levelEl = document.getElementById("level");
  const livesEl = document.getElementById("lives");
  const timeEl  = document.getElementById("time");
  const effectEl= document.getElementById("effect");

  const stageEl = document.getElementById("stage");
  const canvas = document.getElementById("game");
  const g = canvas.getContext("2d");

  const gameOverOverlay = document.getElementById("gameOverOverlay");
  const goCaught = document.getElementById("goCaught");
  const goScore  = document.getElementById("goScore");
  const goTime   = document.getElementById("goTime");
  const playerNameEl = document.getElementById("playerName");
  const submitScoreBtn = document.getElementById("submitScoreBtn");
  const closeGoBtn = document.getElementById("closeGoBtn");
  const submitHint = document.getElementById("submitHint");
  const goLbList = document.getElementById("goLbList");

  const lbOverlay = document.getElementById("lbOverlay");
  const lbRefreshBtn = document.getElementById("lbRefreshBtn");
  const lbCloseBtn = document.getElementById("lbCloseBtn");
  const lbList = document.getElementById("lbList");

  const confettiCanvas = document.getElementById("confettiCanvas");
  const cctx = confettiCanvas.getContext("2d");

  menuBtn.addEventListener("click", () => window.location.href = "../index.html");

  function openOverlay(el){ el.style.display = "flex"; }
  function closeOverlay(el){ el.style.display = "none"; }

  // -----------------------------
  // Responsive canvas (square)
  // -----------------------------
  function fitCanvas(){
    const r = stageEl.getBoundingClientRect();
    const pxW = Math.max(360, Math.floor(r.width * devicePixelRatio));
    const pxH = Math.max(360, Math.floor(r.height * devicePixelRatio));
    canvas.width = pxW;
    canvas.height = pxH;
  }
  window.addEventListener("resize", fitCanvas);
  fitCanvas();

  // -----------------------------
  // Assets (optional)
  // -----------------------------
  const bgImg = new Image();
  bgImg.src = "coffee_bg.png";
  let bgOk = false;
  bgImg.onload = () => bgOk = true;
  bgImg.onerror = () => bgOk = false;

  const bagImg1 = new Image();
  bagImg1.src = "bag1.png";
  let bagOk = false;
  bagImg1.onload = () => bagOk = true;
  bagImg1.onerror = () => bagOk = false;

  // -----------------------------
  // Game tuning (slow start + ramps)
  // -----------------------------
  const USE_LIVES = true;
  const START_LIVES = 3;

  const BASE_SPAWN_MS = 640;      // slower start
  const MIN_SPAWN_MS  = 270;
  const SPAWN_STEP_MS = 22;

  const BASE_SPEED = 0.68;        // slower fall start
  const SPEED_STEP = 0.085;

  const BEAN_R = 0.028;           // bigger beans
  const GOLD_R = 0.031;

  const RATE_GOLD = 0.10;
  const RATE_BLUE = 0.08;
  const RATE_RED  = 0.07;

  const CHILL_MS = 3200;
  const RUSH_MS  = 2800;

  // Bag sizing (bigger + keep aspect ratio)
  const BAG_TARGET_W = 0.28;      // ‚úÖ bigger (normalized)
  const BAG_MIN_H = 0.16;

  // BG transparency controls
  const BG_ALPHA = 0.80;          // ‚úÖ makes bg slightly transparent
  const BG_OVERLAY = 0.10;        // subtle dark overlay so beans pop

  // -----------------------------
  // State
  // -----------------------------
  let running = false;
  let paused = false;

  let lives = START_LIVES;
  let caught = 0;
  let score  = 0;
  let level  = 0;

  let startTime = 0;
  let elapsedSec = 0;
  let timerId = null;

  let lastSpawn = 0;

  let bag = { x: 0.5, y: 0.86, w: BAG_TARGET_W, h: BAG_MIN_H };

  let drops = []; // {x,y,vy,type,points,r}

  let pointerX = null;
  let keys = { left:false, right:false };

  let effect = { name:"‚Äî", until:0, chill:false, rush:false };

  let canSubmitScoreThisGame = false;
  let scoreSubmittedThisGame = false;
  let gameId = "";

  function newGameId(){
    return `coffee_${Date.now()}_${Math.random().toString(16).slice(2)}`;
  }

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function rand(){ return Math.random(); }

  function formatTime(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function setPills(){
    caughtEl.textContent = String(caught);
    scoreEl.textContent  = String(score);
    levelEl.textContent  = String(level);
    livesEl.textContent  = String(lives);
    timeEl.textContent   = formatTime(elapsedSec);
    effectEl.textContent = effect.name;
  }

  function stopTimer(){
    if (timerId) clearInterval(timerId);
    timerId = null;
  }

  function startTimer(){
    stopTimer();
    startTime = Date.now();
    timerId = setInterval(() => {
      if (!running || paused) return;
      elapsedSec = Math.floor((Date.now() - startTime)/1000);
      timeEl.textContent = formatTime(elapsedSec);
    }, 250);
  }

  function resetRunState(){
    drops = [];
    caught = 0;
    score = 0;
    level = 0;
    elapsedSec = 0;
    lastSpawn = 0;
    pointerX = null;
    effect = { name:"‚Äî", until:0, chill:false, rush:false };

    lives = START_LIVES;
    bag.w = BAG_TARGET_W;
    bag.h = BAG_MIN_H;
    bag.x = 0.5;

    canSubmitScoreThisGame = false;
    scoreSubmittedThisGame = false;
    submitScoreBtn.disabled = false;
    submitScoreBtn.textContent = "‚úÖ Submit Score";
    submitHint.textContent = "";
    gameId = newGameId();

    setPills();
  }

  // -----------------------------
  // Input (touch/mouse)
  // -----------------------------
  function setPointerFromEvent(e){
    const r = stageEl.getBoundingClientRect();
    const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    const x = (clientX - r.left) / r.width;
    pointerX = clamp(x, 0, 1);
  }

  stageEl.addEventListener("pointerdown", (e) => {
    stageEl.setPointerCapture(e.pointerId);
    setPointerFromEvent(e);
  });
  stageEl.addEventListener("pointermove", (e) => {
    if (e.buttons === 0 && e.pointerType !== "touch") { setPointerFromEvent(e); return; }
    setPointerFromEvent(e);
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") keys.left = true;
    if (e.key === "ArrowRight"|| e.key.toLowerCase() === "d") keys.right = true;
    if (e.key === " "){
      e.preventDefault();
      if (running) togglePause();
    }
  });
  window.addEventListener("keyup", (e) => {
    if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a") keys.left = false;
    if (e.key === "ArrowRight"|| e.key.toLowerCase() === "d") keys.right = false;
  });

  // -----------------------------
  // Progression (every 10 caught)
  // -----------------------------
  function computeLevel(){ return Math.floor(caught / 10); }

  function currentSpawnMs(){
    const base = BASE_SPAWN_MS - computeLevel()*SPAWN_STEP_MS;
    let v = clamp(base, MIN_SPAWN_MS, BASE_SPAWN_MS);
    if (effect.chill) v = Math.floor(v * 1.35);
    if (effect.rush)  v = Math.floor(v * 0.78);
    return v;
  }

  function currentSpeed(){
    let v = BASE_SPEED * (1 + computeLevel()*SPEED_STEP);
    if (effect.chill) v *= 0.62;
    if (effect.rush)  v *= 1.35;
    return v;
  }

  function maybeExpireEffect(now){
    if (effect.until && now > effect.until){
      effect = { name:"‚Äî", until:0, chill:false, rush:false };
      bag.w = BAG_TARGET_W;
      bag.h = BAG_MIN_H;
    }
  }

  // -----------------------------
  // Spawn logic (4 beans only)
  // -----------------------------
  function pickBeanType(){
    const r = rand();
    if (r < RATE_GOLD) return "gold";
    if (r < RATE_GOLD + RATE_BLUE) return "blue";
    if (r < RATE_GOLD + RATE_BLUE + RATE_RED) return "red";
    return "normal";
  }

  function spawnDrop(now){
    const spawnMs = currentSpawnMs();
    if (now - lastSpawn < spawnMs) return;
    lastSpawn = now;

    const x = clamp(0.06 + rand()*0.88, 0.05, 0.95);
    const baseVy = currentSpeed() * (0.92 + rand()*0.45);

    const type = pickBeanType();
    const points = (type === "gold") ? 5 : (type === "normal" ? 1 : 0);
    const r = (type === "gold") ? GOLD_R : BEAN_R;

    drops.push({ x, y:-0.06, vy: baseVy, type, points, r });
  }

  // -----------------------------
  // Movement + collisions
  // -----------------------------
  function bagMove(){
    if (pointerX !== null){
      bag.x += (pointerX - bag.x) * 0.22;
    } else {
      const speed = 0.018;
      if (keys.left) bag.x -= speed;
      if (keys.right) bag.x += speed;
    }

    // Rush makes bag smaller
    if (effect.rush){
      bag.w = BAG_TARGET_W * 0.88;
    } else {
      bag.w = BAG_TARGET_W;
    }

    bag.x = clamp(bag.x, bag.w*0.5 + 0.02, 1 - bag.w*0.5 - 0.02);
  }

  function rectHit(drop){
    const left = bag.x - bag.w/2, right = bag.x + bag.w/2;
    const top  = bag.y - bag.h/2, bottom= bag.y + bag.h/2;
    return (drop.x > left && drop.x < right && drop.y > top && drop.y < bottom);
  }

  function loseLife(){
    if (!USE_LIVES) return;
    lives--;
    if (lives <= 0) gameOver();
  }

  function applyBeanEffect(type, now){
    if (type === "blue"){
      effect = { name:"üîµ Chill", until: now + CHILL_MS, chill:true, rush:false };
    } else if (type === "red"){
      effect = { name:"üî¥ Rush", until: now + RUSH_MS, chill:false, rush:true };
    }
  }

  function updateDrops(dt, now){
    for (let i = drops.length - 1; i >= 0; i--){
      const d = drops[i];
      d.y += d.vy * dt;

      if (rectHit(d)){
        caught += 1;
        level = computeLevel();

        if (d.type === "normal" || d.type === "gold"){
          score += d.points;
        } else {
          applyBeanEffect(d.type, now);
        }

        drops.splice(i,1);
        continue;
      }

      if (d.y > 1.10){
        if (d.type === "normal" || d.type === "gold") loseLife();
        drops.splice(i,1);
      }
    }
  }

  // -----------------------------
  // Draw
  // -----------------------------
  function drawBackground(w,h){
    if (bgOk){
      const iw = bgImg.width || 1;
      const ih = bgImg.height || 1;
      const scale = Math.max(w/iw, h/ih);
      const dw = iw*scale, dh = ih*scale;
      const dx = (w - dw)/2, dy = (h - dh)/2;

      g.save();
      g.globalAlpha = BG_ALPHA;         // ‚úÖ transparency
      g.drawImage(bgImg, dx, dy, dw, dh);
      g.restore();

      // subtle overlay to make beans/bag readable
      g.fillStyle = `rgba(0,0,0,${BG_OVERLAY})`;
      g.fillRect(0,0,w,h);
      return;
    }

    // fallback
    const grd = g.createLinearGradient(0,0,0,h);
    grd.addColorStop(0, "rgba(255,255,255,.08)");
    grd.addColorStop(1, "rgba(0,0,0,.12)");
    g.fillStyle = grd;
    g.fillRect(0,0,w,h);
  }

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    g.beginPath();
    g.moveTo(x+rr,y);
    g.arcTo(x+w,y,x+w,y+h,rr);
    g.arcTo(x+w,y+h,x,y+h,rr);
    g.arcTo(x,y+h,x,y,rr);
    g.arcTo(x,y,x+w,y,rr);
    g.closePath();
  }

  function drawBag(w,h){
    const bx = bag.x*w, by = bag.y*h;

    // ‚úÖ size from width, keep aspect ratio (prevents squish)
    const targetW = bag.w*w;

    if (bagOk){
      const iw = bagImg1.width || 1;
      const ih = bagImg1.height || 1;
      const ar = iw / ih;

      // compute height to keep AR
      const drawW = targetW;
      const drawH = Math.max(BAG_MIN_H*h, drawW / ar);

      // update collision height gently to match the image (not perfect but close)
      bag.h = clamp(drawH / h, 0.12, 0.26);

      g.save();
      g.translate(bx,by);
      g.imageSmoothingEnabled = true;
      g.drawImage(bagImg1, -drawW/2, -drawH/2, drawW, drawH);
      g.restore();
      return;
    }

    // fallback bag
    const bw = targetW;
    const bh = Math.max(BAG_MIN_H*h, bag.h*h);

    g.save();
    g.translate(bx,by);
    g.fillStyle = "rgba(255, 221, 85, .92)";
    g.strokeStyle = "rgba(0,0,0,.55)";
    g.lineWidth = Math.max(2, 2.2 * devicePixelRatio);

    const r = Math.min(18*devicePixelRatio, bw*0.2);
    roundRect(-bw/2, -bh/2, bw, bh, r);
    g.fill(); g.stroke();

    g.fillStyle = "rgba(0,0,0,.10)";
    roundRect(-bw/2, -bh/2, bw, bh*0.22, r);
    g.fill();

    g.fillStyle = "rgba(0,0,0,.16)";
    roundRect(-bw*0.26, -bh*0.05, bw*0.52, bh*0.46, r*0.8);
    g.fill();

    g.fillStyle = "rgba(0,0,0,.78)";
    g.font = `${Math.max(10, 11*devicePixelRatio)}px system-ui, -apple-system, sans-serif`;
    g.textAlign = "center";
    g.textBaseline = "middle";
    g.fillText("COFFEE", 0, bh*0.10);
    g.restore();
  }

  function drawBean(d,w,h){
    const x = d.x*w, y = d.y*h;
    const rr = d.r*w;

    g.save();
    g.translate(x,y);

    if (d.type === "gold") g.fillStyle = "rgba(255,215,0,.97)";
    else if (d.type === "blue") g.fillStyle = "rgba(110,200,255,.95)";
    else if (d.type === "red")  g.fillStyle = "rgba(255,110,110,.95)";
    else g.fillStyle = "rgba(120,70,40,.97)";

    g.strokeStyle = "rgba(0,0,0,.45)";
    g.lineWidth = Math.max(2, 2*devicePixelRatio);

    g.beginPath();
    g.ellipse(0,0, rr*1.25, rr*0.92, Math.PI/6, 0, Math.PI*2);
    g.fill();
    g.stroke();

    if (d.type === "normal" || d.type === "gold"){
      g.strokeStyle = "rgba(0,0,0,.20)";
      g.lineWidth = Math.max(1, 1.3*devicePixelRatio);
      g.beginPath();
      g.moveTo(-rr*0.4, -rr*0.55);
      g.quadraticCurveTo(0,0, -rr*0.35, rr*0.55);
      g.stroke();
    }

    g.fillStyle = "rgba(0,0,0,.75)";
    g.font = `${Math.max(10, 12*devicePixelRatio)}px system-ui, -apple-system, sans-serif`;
    g.textAlign = "center";
    g.textBaseline = "middle";
    if (d.type === "blue") g.fillText("‚ùÑÔ∏è", 0, 0);
    if (d.type === "red")  g.fillText("üî•", 0, 0);

    g.restore();
  }

  function drawHUD(w,h){
    if (!running){
      g.save();
      g.fillStyle = "rgba(0,0,0,.18)";
      g.fillRect(0,0,w,h);
      g.fillStyle = "rgba(255,255,255,.95)";
      g.font = `${Math.max(16, 18*devicePixelRatio)}px system-ui, -apple-system, sans-serif`;
      g.textAlign = "center";
      g.textBaseline = "middle";
      g.fillText("Press ‚ñ∂Ô∏è Start to play", w/2, h*0.18);
      g.restore();
      return;
    }

    if (paused){
      g.save();
      g.fillStyle = "rgba(0,0,0,.42)";
      g.fillRect(0,0,w,h);
      g.fillStyle = "rgba(255,255,255,.95)";
      g.font = `${Math.max(18, 22*devicePixelRatio)}px system-ui, -apple-system, sans-serif`;
      g.textAlign = "center";
      g.textBaseline = "middle";
      g.fillText("PAUSED", w/2, h/2);
      g.restore();
      return;
    }

    if (effect.chill || effect.rush){
      g.save();
      g.globalAlpha = 0.22;
      g.fillStyle = effect.chill ? "rgba(110,200,255,1)" : "rgba(255,110,110,1)";
      g.fillRect(0,0,w,Math.max(18*devicePixelRatio, h*0.035));
      g.restore();

      g.save();
      g.fillStyle = "rgba(0,0,0,.72)";
      g.font = `${Math.max(10, 12*devicePixelRatio)}px system-ui, -apple-system, sans-serif`;
      g.textAlign = "center";
      g.textBaseline = "middle";
      g.fillText(effect.chill ? "CHILL!" : "RUSH!", w/2, Math.max(10*devicePixelRatio, h*0.017));
      g.restore();
    }
  }

  // -----------------------------
  // Loop
  // -----------------------------
  let lastT = 0;
  function tick(){
    requestAnimationFrame(tick);
    const now = performance.now();
    const w = canvas.width, h = canvas.height;

    if (!lastT) lastT = now;
    const dt = paused || !running ? 0 : ((now - lastT)/1000);
    lastT = now;

    if (running && !paused){
      maybeExpireEffect(now);
      spawnDrop(now);
      bagMove();
      updateDrops(dt, now);
      level = computeLevel();
      setPills();
    }

    g.clearRect(0,0,w,h);
    drawBackground(w,h);
    for (const d of drops) drawBean(d,w,h);
    drawBag(w,h);
    drawHUD(w,h);
  }
  requestAnimationFrame(tick);

  // -----------------------------
  // Buttons
  // -----------------------------
  function setButtons(){
    startBtn.disabled = running && !paused;
    pauseBtn.disabled = !running;
    pauseBtn.textContent = paused ? "‚ñ∂Ô∏è Resume" : "‚è∏Ô∏è Pause";
  }

  function startGame(){
    resetRunState();
    running = true;
    paused = false;
    lastT = 0;
    startTimer();
    setButtons();
  }

  function togglePause(){
    if (!running) return;
    paused = !paused;
    if (!paused){
      startTime = Date.now() - elapsedSec*1000;
      lastT = 0;
    }
    setButtons();
  }

  function resetGame(){
    running = false;
    paused = false;
    stopTimer();
    resetRunState();
    setButtons();
  }

  startBtn.addEventListener("click", startGame);
  pauseBtn.addEventListener("click", togglePause);
  resetBtn.addEventListener("click", resetGame);

  // -----------------------------
  // Game Over + Leaderboard
  // -----------------------------
  function gameOver(){
    running = false;
    paused = false;
    stopTimer();
    setButtons();

    goCaught.textContent = String(caught);
    goScore.textContent  = String(score);
    goTime.textContent   = formatTime(elapsedSec);

    canSubmitScoreThisGame = true;
    scoreSubmittedThisGame = false;

    const p = getPlayer();
    playerNameEl.value = p.rawName || "";

    if (!firebaseOk){
      submitScoreBtn.disabled = true;
      submitHint.textContent = "Firebase isn‚Äôt loading ‚Äî test via your GitHub Pages URL and check Console.";
    } else {
      submitScoreBtn.disabled = false;
      submitHint.textContent = "Submit your score (only once).";
    }

    openOverlay(gameOverOverlay);
    fireConfetti();
    refreshLeaderboardInto(goLbList);
  }

  closeGoBtn.addEventListener("click", () => {
    closeOverlay(gameOverOverlay);
    stopConfetti();
  });

  submitScoreBtn.addEventListener("click", async () => {
    if (!canSubmitScoreThisGame || scoreSubmittedThisGame){
      alert("You can only submit 1 score per game ‚úÖ");
      return;
    }

    const name = (playerNameEl.value || "").trim().slice(0,20);
    if (!name){
      alert("Name must be 1‚Äì20 characters.");
      return;
    }
    if (name.toLowerCase() === "anon" || name.toLowerCase() === "anonymous"){
      alert("Please use a real name (not Anon).");
      return;
    }

    setPlayerName(name);

    if (!firebaseOk){
      alert("Firebase isn't loading. Test using your GitHub Pages URL (not file://) and check Console errors.");
      return;
    }

    scoreSubmittedThisGame = true;
    canSubmitScoreThisGame = false;
    submitScoreBtn.disabled = true;
    submitScoreBtn.textContent = "‚úÖ Submitted";

    try{
      const ref = doc(db, "coffee_scores", gameId);

      await setDoc(ref, {
        name,
        caught,
        score,
        time: elapsedSec,
        gameId,
        createdAt: serverTimestamp()
      });

      alert("Score submitted! ‚úÖ");
      await refreshLeaderboardInto(goLbList);

    } catch (e){
      console.error(e);
      scoreSubmittedThisGame = false;
      canSubmitScoreThisGame = true;
      submitScoreBtn.disabled = false;
      submitScoreBtn.textContent = "‚úÖ Submit Score";
      alert("Couldn‚Äôt submit score. Check Firestore rules + indexes. (Open Console for exact error.)");
    }
  });

  leaderboardBtn.addEventListener("click", async () => {
    openOverlay(lbOverlay);
    await refreshLeaderboardInto(lbList);
  });

  lbCloseBtn.addEventListener("click", () => closeOverlay(lbOverlay));
  lbRefreshBtn.addEventListener("click", async () => {
    await refreshLeaderboardInto(lbList);
  });

  async function refreshLeaderboardInto(targetEl){
    targetEl.innerHTML = "";

    const header = document.createElement("div");
    header.className = "lbRow";
    header.innerHTML = `<span class="muted">Top 10</span><span class="muted">Score ‚Ä¢ Time</span>`;
    targetEl.appendChild(header);

    if (!firebaseOk){
      const row = document.createElement("div");
      row.className = "lbRow";
      row.innerHTML = `<span class="muted">Firebase failed to load</span><span class="muted">Check Console</span>`;
      targetEl.appendChild(row);
      return;
    }

    try{
      const q = query(
        collection(db, "coffee_scores"),
        orderBy("score","desc"),
        orderBy("time","desc"),
        limit(10)
      );

      const snap = await getDocs(q);

      if (snap.empty){
        const row = document.createElement("div");
        row.className = "lbRow";
        row.innerHTML = `<span class="muted">No scores yet</span><span class="muted">‚Äî</span>`;
        targetEl.appendChild(row);
        return;
      }

      let rank = 1;
      snap.forEach(docSnap => {
        const s = docSnap.data();
        const row = document.createElement("div");
        row.className = "lbRow";

        if (rank === 1) row.classList.add("top1");
        if (rank === 2) row.classList.add("top2");
        if (rank === 3) row.classList.add("top3");

        row.innerHTML = `
          <span>${rank}. ${escapeHtml(s.name || "Anon")} <span class="muted">(${Number(s.caught||0)} caught)</span></span>
          <span>${Number(s.score||0)} ‚Ä¢ ${formatTime(Number(s.time||0))}</span>
        `;
        targetEl.appendChild(row);

        if (rank === 3){
          const div = document.createElement("div");
          div.className = "lbDivider";
          targetEl.appendChild(div);
        }

        rank++;
      });

    } catch (e){
      console.error(e);
      const row = document.createElement("div");
      row.className = "lbRow";
      row.innerHTML = `<span class="muted">Leaderboard error</span><span class="muted">Rules/index</span>`;
      targetEl.appendChild(row);
    }
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // -----------------------------
  // Confetti
  // -----------------------------
  function resizeConfettiCanvas(){
    confettiCanvas.width = Math.floor(window.innerWidth * devicePixelRatio);
    confettiCanvas.height = Math.floor(window.innerHeight * devicePixelRatio);
  }
  window.addEventListener("resize", resizeConfettiCanvas);

  let confetti = [];
  let confettiAnim = null;

  function fireConfetti(){
    resizeConfettiCanvas();
    confettiCanvas.style.display = "block";
    confetti = [];
    const count = 180;

    for (let i=0;i<count;i++){
      confetti.push({
        x: Math.random()*confettiCanvas.width,
        y: -Math.random()*confettiCanvas.height*0.2,
        vx: (Math.random()-0.5)*2.2*devicePixelRatio,
        vy: (2.5 + Math.random()*4.5)*devicePixelRatio,
        r: (3 + Math.random()*6)*devicePixelRatio,
        a: Math.random()*Math.PI*2,
        va: (Math.random()-0.5)*0.25,
        c: `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`
      });
    }

    const start = performance.now();
    const dur = 2200;

    const tick = (t) => {
      cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      for (const p of confetti){
        p.x += p.vx; p.y += p.vy; p.a += p.va;
        if (p.x < -50) p.x = confettiCanvas.width + 50;
        if (p.x > confettiCanvas.width + 50) p.x = -50;

        cctx.save();
        cctx.translate(p.x, p.y);
        cctx.rotate(p.a);
        cctx.fillStyle = p.c;
        cctx.fillRect(-p.r, -p.r*0.6, p.r*2, p.r*1.2);
        cctx.restore();
      }
      if (t - start < dur) confettiAnim = requestAnimationFrame(tick);
      else stopConfetti();
    };

    confettiAnim = requestAnimationFrame(tick);
  }

  function stopConfetti(){
    if (confettiAnim) cancelAnimationFrame(confettiAnim);
    confettiAnim = null;
    confettiCanvas.style.display = "none";
  }

  // -----------------------------
  // Init
  // -----------------------------
  resetRunState();
  setButtons();
  setPills();
</script>

</body>
</html>

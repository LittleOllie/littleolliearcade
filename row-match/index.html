<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Little Ollie Row Match</title>

  <style>
    *{ box-sizing:border-box; }
    :root{
      --gap: 6px;
      --radius: 16px;
      --panel: rgba(0,0,0,.18);
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --tileShadow: 0 10px 20px rgba(0,0,0,.25);
      --btnYellow: #ffdd55;
      --btnText: #222;
    }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px 10px 26px;
      background: radial-gradient(circle at top, #6de0ff, #4c6fff);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color:#fff;
    }

    .wrap{
      width: 980px;
      max-width: 96vw;
    }

    .panel{
      background: var(--panel);
      border-radius: 22px;
      padding: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .header-img{
      width:100%;
      display:block;
      border-radius: 16px;
      margin-bottom: 10px;
    }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* ‚úÖ ALL BUTTONS SAME YELLOW */
    .btn{
      border:0;
      cursor:pointer;
      padding:10px 12px;
      border-radius: 14px;
      background: var(--btnYellow);
      color: var(--btnText);
      font-weight: 950;
      letter-spacing:.2px;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      transition: transform .08s ease, filter .15s ease;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn:disabled{ cursor:not-allowed; opacity:.6; transform:none; }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      font-weight: 900;
    }
    .pill{
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      white-space:nowrap;
    }

    .game-area{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .board-wrap{
      position:relative;
      border-radius: 20px;
      background: rgba(0,0,0,.10);
      padding: 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
    }

    .board{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--gap);
    }

    .tile{
      position:relative;
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: var(--radius);
      background: rgba(255,255,255,.10);
      overflow:hidden;
      box-shadow: var(--tileShadow);
      transform: translateZ(0);
    }

    .tile button{
      all: unset;
      width:100%;
      height:100%;
      display:block;
      cursor:pointer;
    }

    .tile img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    .tile.empty{
      background: rgba(0,0,0,.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
    }
    .tile.empty button{ cursor: default; }

    .disabled .tile button{ cursor: default; }

    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(2px);
      border-radius: 20px;
      font-weight: 950;
      letter-spacing: .3px;
      text-align:center;
      padding: 18px;
    }
    .overlay.show{ display:flex; }

    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(3px);
      z-index: 9999;
    }
    .modal.show{ display:flex; }

    .modal-card{
      width: min(900px, 96vw);
      max-height: 86vh;
      overflow:auto;
      border-radius: 22px;
      background: rgba(20,22,30,.95);
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.12);
      padding: 14px;
    }

    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }

    .modal-title{
      font-size: 18px;
      font-weight: 950;
      letter-spacing: .2px;
    }

    .section{
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.10);
      margin-bottom: 12px;
    }

    .small{
      opacity:.92;
      line-height: 1.4;
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
    }
    th, td{
      padding:10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      text-align:left;
      font-weight: 800;
      font-size: 14px;
    }
    th{
      opacity:.95;
      font-weight: 950;
    }

    /* ‚úÖ Podium shades */
    tr.top1{ background: rgba(255, 215, 0, .18); }
    tr.top2{ background: rgba(192, 192, 192, .16); }
    tr.top3{ background: rgba(205, 127, 50, .14); }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    input{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color:#fff;
      outline:none;
      font-weight: 900;
      width: min(320px, 80vw);
    }
    input::placeholder{ color: rgba(255,255,255,.7); }

    .note{
      opacity:.88;
      font-weight: 750;
      font-size: 13px;
      margin-top: 8px;
      line-height:1.35;
    }

    .win-banner{
      display:none;
      margin-top: 10px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(0, 255, 170, .14);
      border: 1px solid rgba(0, 255, 170, .22);
      font-weight: 950;
    }
    .win-banner.show{ display:block; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
    }

    @media (max-width: 520px){
      .btn{ padding:10px 11px; border-radius: 12px; }
      .pill{ padding:10px 11px; border-radius: 12px; }
      th, td{ font-size: 13px; padding:9px 9px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">

      <img class="header-img" src="header.png" alt="Header" />

      <div class="topbar">
        <div class="tabs">
          <button class="btn" id="btnBackMenu">üïπÔ∏è Arcade Menu</button>
          <button class="btn" id="btnLeaderboard">üèÜ Leaderboard</button>
          <button class="btn" id="btnHow">üìñ How To Play</button>
          <button class="btn" id="btnNew">üÜï New Game</button>
          <button class="btn" id="btnStart">‚ñ∂Ô∏è Start</button>
          <button class="btn" id="btnReset">üîÑ Reset</button>
        </div>

        <div class="stats">
          <div class="pill">‚è±Ô∏è <span id="timeText">0</span>s</div>
          <div class="pill">üß† Moves: <span id="movesText">0</span></div>
        </div>
      </div>

      <div class="game-area">
        <div class="board-wrap" id="boardWrap">
          <div class="overlay" id="overlay">üåÄ Shuffling‚Ä¶<br/>Get ready!</div>
          <div class="board" id="board"></div>

          <div class="win-banner" id="winBanner">
            üéâ You did it! Rows are matched.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- PLAYER LOGIN MODAL -->
  <div class="modal" id="playerModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title">üë§ Choose Player</div>
        <div class="chip" id="playerHint">Scores need a name</div>
      </div>

      <div class="section small">
        <p style="margin:0 0 10px 0;">
          Pick a username (no password) to submit scores ‚Äî or play as <b>Anon</b> (no submitting).
        </p>

        <div class="row" style="margin-top:10px;">
          <input id="playerNameInput" maxlength="20" placeholder="‚úçÔ∏è Enter username (1‚Äì20 chars)" />
          <button class="btn" id="playerSaveBtn">‚úÖ Use This Name</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="playerAnonBtn">üôà Play as Anon</button>
        </div>

        <div class="note" id="playerNote"></div>
      </div>
    </div>
  </div>

  <!-- HOW TO PLAY MODAL -->
  <div class="modal" id="howModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title">üìñ How To Play</div>
        <button class="btn" id="howBack">‚¨ÖÔ∏è Back</button>
      </div>

      <div class="section small">
        <p><b>Goal:</b> Make each row contain the same character.</p>
        <ul>
          <li>There are <b>4 different characters</b> each game.</li>
          <li>Three characters have <b>5 tiles</b> each.</li>
          <li>One character has <b>4 tiles</b> (because there‚Äôs <b>1 empty space</b> you slide into).</li>
        </ul>
        <p><b>How to move:</b> Tap a tile that is directly next to the empty space (up/down/left/right) to slide it.</p>
        <p><b>New Game:</b> Picks 4 new characters and shows a solved board.</p>
        <p><b>Start:</b> Shuffles the <b>current</b> characters for 3 seconds (always solvable).</p>
        <p><b>Reset:</b> Returns to solved using the <b>current</b> characters.</p>
        <p><b>Scoring:</b> Faster time is better. If time ties, fewer moves wins.</p>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD MODAL -->
  <div class="modal" id="lbModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title">üèÜ Leaderboard (Top 10)</div>
        <button class="btn" id="lbBack">‚¨ÖÔ∏è Back</button>
      </div>

      <div class="section">
        <div class="row" style="justify-content:space-between;">
          <div class="chip">üë§ <span id="playerDisplay">Anon</span></div>
          <button class="btn" id="changePlayerBtn">üîÅ Change Player</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <input id="nameInput" maxlength="20" placeholder="‚úçÔ∏è Your name (1‚Äì20 chars)" />
          <button class="btn" id="submitScoreBtn">‚úÖ Submit Score</button>
        </div>
        <div class="note" id="submitNote">
          Finish a game first ‚Äî then submit. (Only 1 submission per win.)
        </div>
      </div>

      <div class="section">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Time</th>
              <th>Moves</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="lbBody">
            <tr><td colspan="5">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const PUZZLE_FOLDER = "puzzles";
    const MIN_IMG = 1;
    const MAX_IMG = 100;

    const SCORES_COLLECTION = "scores";

    const firebaseConfig = {
      apiKey: "AIzaSyBjKE9UqfwhLTgKywMlmC0IVdAD5xPJs7Q",
      authDomain: "littleollierowmatch.firebaseapp.com",
      projectId: "littleollierowmatch",
      storageBucket: "littleollierowmatch.firebasestorage.app",
      messagingSenderId: "232794121702",
      appId: "1:232794121702:web:7fea3de6e6a5a58ac32227",
      measurementId: "G-WGK6L2JGLS"
    };

    const W = 5, H = 4, N = W * H;

    let board = new Array(N).fill(-1);
    let emptyIndex = N - 1;

    let gameStarted = false;
    let shuffling = false;
    let won = false;

    let moves = 0;
    let startTimeMs = 0;
    let timerHandle = null;

    let winId = "";
    let scoreSubmitted = false;

    let chosenImgs = [];

    // ‚úÖ Player system (saved like memory game)
    const LS_PLAYER_NAME = "lo_rowmatch_playerName";
    const LS_PLAYER_ANON = "lo_rowmatch_isAnon";
    let playerName = "";
    let isAnon = true;

    const boardEl = document.getElementById("board");
    const overlayEl = document.getElementById("overlay");
    const boardWrapEl = document.getElementById("boardWrap");

    const timeText = document.getElementById("timeText");
    const movesText = document.getElementById("movesText");

    const btnBackMenu = document.getElementById("btnBackMenu");
    const btnNew = document.getElementById("btnNew");
    const btnStart = document.getElementById("btnStart");
    const btnReset = document.getElementById("btnReset");
    const btnLeaderboard = document.getElementById("btnLeaderboard");
    const btnHow = document.getElementById("btnHow");

    const howModal = document.getElementById("howModal");
    const howBack = document.getElementById("howBack");

    const lbModal = document.getElementById("lbModal");
    const lbBack = document.getElementById("lbBack");
    const lbBody = document.getElementById("lbBody");
    const nameInput = document.getElementById("nameInput");
    const submitScoreBtn = document.getElementById("submitScoreBtn");
    const submitNote = document.getElementById("submitNote");

    const winBanner = document.getElementById("winBanner");

    // Player modal
    const playerModal = document.getElementById("playerModal");
    const playerNameInput = document.getElementById("playerNameInput");
    const playerSaveBtn = document.getElementById("playerSaveBtn");
    const playerAnonBtn = document.getElementById("playerAnonBtn");
    const playerNote = document.getElementById("playerNote");
    const playerDisplay = document.getElementById("playerDisplay");
    const changePlayerBtn = document.getElementById("changePlayerBtn");

    let db = null;
    let firebaseReady = false;

    function initFirebaseIfConfigured(){
      try{
        if(!firebaseConfig || !firebaseConfig.projectId){
          firebaseReady = false;
          return;
        }
        // ‚úÖ Guard: don't double-init
        if (firebase.apps && firebase.apps.length === 0){
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        firebaseReady = true;
      }catch(e){
        firebaseReady = false;
        console.warn("Firebase init error:", e);
      }
    }

    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function pick4UniqueImages(){
      const set = new Set();
      while(set.size < 4){
        set.add(randInt(MIN_IMG, MAX_IMG));
      }
      return Array.from(set);
    }

    function imgSrcForType(typeIndex){
      const imgNum = chosenImgs[typeIndex];
      return `${PUZZLE_FOLDER}/${imgNum}.png`;
    }

    function idxToRC(i){ return { r: Math.floor(i / W), c: i % W }; }
    function rcToIdx(r,c){ return r * W + c; }

    function neighbors(i){
      const {r,c} = idxToRC(i);
      const out = [];
      if(r>0) out.push(rcToIdx(r-1,c));
      if(r<H-1) out.push(rcToIdx(r+1,c));
      if(c>0) out.push(rcToIdx(r,c-1));
      if(c<W-1) out.push(rcToIdx(r,c+1));
      return out;
    }

    function canMove(i){ return neighbors(i).includes(emptyIndex); }

    function setDisabledUI(disabled){
      if(disabled) boardWrapEl.classList.add("disabled");
      else boardWrapEl.classList.remove("disabled");
    }

    function formatDate(ts){
      try{
        const d = ts instanceof Date ? ts : new Date(ts);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }catch{
        return "";
      }
    }

    function newWinId(){
      return `win_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function openModal(el){
      el.classList.add("show");
      el.setAttribute("aria-hidden","false");
    }
    function closeModal(el){
      el.classList.remove("show");
      el.setAttribute("aria-hidden","true");
    }

    // ‚úÖ Load player from localStorage
    function loadPlayer(){
      const savedName = (localStorage.getItem(LS_PLAYER_NAME) || "").trim();
      const savedAnon = localStorage.getItem(LS_PLAYER_ANON);

      if(savedAnon === "false" && savedName.length >= 1){
        playerName = savedName;
        isAnon = false;
      }else if(savedAnon === "true"){
        playerName = "";
        isAnon = true;
      }else if(savedName.length >= 1){
        // if name exists but anon flag missing, assume named player
        playerName = savedName;
        isAnon = false;
      }else{
        playerName = "";
        isAnon = true;
      }

      syncPlayerUI();
    }

    function setPlayerNamed(name){
      playerName = name.trim().slice(0,20);
      isAnon = false;
      localStorage.setItem(LS_PLAYER_NAME, playerName);
      localStorage.setItem(LS_PLAYER_ANON, "false");
      syncPlayerUI();
    }

    function setPlayerAnon(){
      playerName = "";
      isAnon = true;
      localStorage.removeItem(LS_PLAYER_NAME);
      localStorage.setItem(LS_PLAYER_ANON, "true");
      syncPlayerUI();
    }

    function syncPlayerUI(){
      playerDisplay.textContent = isAnon ? "Anon" : playerName;
      nameInput.value = isAnon ? "" : playerName;

      // if anon, keep placeholder and allow typing BUT it won't submit
      if(isAnon){
        nameInput.placeholder = "Anon mode (no submitting)";
      }else{
        nameInput.placeholder = "‚úçÔ∏è Your name (1‚Äì20 chars)";
      }
      updateSubmitNote();
    }

    function ensurePlayerChosen(){
      // Show modal if no explicit choice yet (neither anon flag nor name)
      const hasAnonFlag = localStorage.getItem(LS_PLAYER_ANON) !== null;
      const hasName = (localStorage.getItem(LS_PLAYER_NAME) || "").trim().length > 0;

      if(!hasAnonFlag && !hasName){
        openModal(playerModal);
        setTimeout(() => playerNameInput.focus(), 50);
      }
    }

    function buildSolvedBoardUsingCurrentImages(){
      if(!chosenImgs || chosenImgs.length !== 4){
        chosenImgs = pick4UniqueImages();
      }

      board = new Array(N).fill(-1);

      for(let c=0;c<4;c++){
        board[rcToIdx(0,c)] = 0;
      }
      board[rcToIdx(0,4)] = -1;
      emptyIndex = rcToIdx(0,4);

      for(let r=1;r<4;r++){
        for(let c=0;c<5;c++){
          board[rcToIdx(r,c)] = r;
        }
      }

      moves = 0;
      movesText.textContent = "0";
      timeText.textContent = "0";

      won = false;
      winBanner.classList.remove("show");

      gameStarted = false;
      shuffling = false;

      scoreSubmitted = false;
      winId = newWinId();
      updateSubmitNote();

      render();
      updateButtons();
    }

    function newGame(){
      stopTimer();
      chosenImgs = pick4UniqueImages();
      buildSolvedBoardUsingCurrentImages();
    }

    function render(){
      boardEl.innerHTML = "";

      for(let i=0;i<N;i++){
        const v = board[i];
        const tile = document.createElement("div");
        tile.className = "tile" + (v === -1 ? " empty" : "");

        const btn = document.createElement("button");
        btn.type = "button";
        btn.setAttribute("aria-label", v === -1 ? "Empty" : "Tile");

        if(v !== -1){
          const img = document.createElement("img");
          img.src = imgSrcForType(v);
          img.alt = "";
          img.draggable = false;
          btn.appendChild(img);
        }

        btn.addEventListener("click", () => {
          if(shuffling) return;
          if(!gameStarted) return;
          if(won) return;
          if(v === -1) return;

          if(canMove(i)){
            doMove(i, true);
          }
        });

        tile.appendChild(btn);
        boardEl.appendChild(tile);
      }
    }

    function doMove(tileIndex, countMove){
      const t = board[tileIndex];
      board[tileIndex] = -1;
      board[emptyIndex] = t;
      emptyIndex = tileIndex;

      if(countMove){
        moves++;
        movesText.textContent = String(moves);
        checkWin();
      }
      render();
    }

    async function onWinOpenLeaderboard(){
      // ‚úÖ This is the missing behaviour you want:
      // Auto-open leaderboard modal right when a win happens
      openModal(lbModal);
      await loadLeaderboard();
      updateSubmitNote(true);

      // focus name box if they can submit
      if(!isAnon && !scoreSubmitted){
        setTimeout(() => nameInput.focus(), 60);
      }
    }

    function checkWin(){
      const rowTypes = [];
      const rowCounts = [];

      for(let r=0;r<H;r++){
        let type = null;
        let count = 0;

        for(let c=0;c<W;c++){
          const v = board[rcToIdx(r,c)];
          if(v === -1) continue;
          count++;
          if(type === null) type = v;
          else if(v !== type) return;
        }

        if(type === null) return;
        rowTypes.push(type);
        rowCounts.push(count);
      }

      const s = new Set(rowTypes);
      if(s.size !== 4) return;

      const sortedCounts = [...rowCounts].sort((a,b)=>a-b).join(",");
      if(sortedCounts !== "4,5,5,5") return;

      won = true;
      stopTimer();
      winBanner.classList.add("show");
      gameStarted = false;
      updateButtons();

      // ‚úÖ force note into "won" state
      updateSubmitNote(true);

      // ‚úÖ AUTO POPUP leaderboard submit
      onWinOpenLeaderboard();
    }

    function startTimer(){
      startTimeMs = Date.now();
      stopTimer();
      timerHandle = setInterval(() => {
        const t = Math.max(0, Math.floor((Date.now() - startTimeMs) / 1000));
        timeText.textContent = String(t);
      }, 200);
    }

    function stopTimer(){
      if(timerHandle){
        clearInterval(timerHandle);
        timerHandle = null;
      }
    }

    function currentTimeSeconds(){
      if(!timerHandle) return Number(timeText.textContent || "0");
      return Math.max(0, Math.floor((Date.now() - startTimeMs) / 1000));
    }

    async function shuffleFor3Seconds(){
      shuffling = true;
      setDisabledUI(true);
      overlayEl.classList.add("show");
      updateButtons();

      const end = performance.now() + 3000;
      let lastEmpty = -1;

      while(performance.now() < end){
        const neigh = neighbors(emptyIndex);

        let options = neigh.filter(n => n !== lastEmpty);
        if(options.length === 0) options = neigh;

        const pick = options[Math.floor(Math.random() * options.length)];
        lastEmpty = emptyIndex;
        doMove(pick, false);

        await new Promise(res => setTimeout(res, 25));
      }

      overlayEl.classList.remove("show");
      setDisabledUI(false);
      shuffling = false;

      moves = 0;
      movesText.textContent = "0";
      timeText.textContent = "0";

      won = false;
      winBanner.classList.remove("show");

      gameStarted = true;
      scoreSubmitted = false;
      winId = newWinId();
      updateSubmitNote();

      startTimer();
      render();
      updateButtons();
    }

    function updateSubmitNote(forceWon){
      const isWonNow = forceWon || won;

      if(!firebaseReady){
        submitNote.textContent = "Leaderboard saving is OFF until Firebase config is added.";
        submitScoreBtn.disabled = true;
        submitScoreBtn.style.opacity = 0.55;
        return;
      }

      if(isAnon){
        submitNote.textContent = "You are playing as Anon ‚Äî scores can‚Äôt be submitted. Tap ‚ÄúChange Player‚Äù to add a username.";
        submitScoreBtn.disabled = true;
        submitScoreBtn.style.opacity = 0.55;
        return;
      }

      // Named player
      submitScoreBtn.disabled = !(isWonNow && !scoreSubmitted);
      submitScoreBtn.style.opacity = submitScoreBtn.disabled ? 0.55 : 1;

      if(!isWonNow){
        submitNote.textContent = "Finish a game first ‚Äî then submit. (Only 1 submission per win.)";
      }else if(scoreSubmitted){
        submitNote.textContent = "Score already submitted for this win ‚úÖ";
      }else{
        submitNote.textContent = "You won! Submit your score (only once).";
      }
    }

    async function loadLeaderboard(){
      if(!firebaseReady){
        lbBody.innerHTML = `<tr><td colspan="5">Firebase not configured yet.</td></tr>`;
        return;
      }

      lbBody.innerHTML = `<tr><td colspan="5">Loading‚Ä¶</td></tr>`;

      try{
        const snap = await db.collection(SCORES_COLLECTION)
          .orderBy("time", "asc")
          .orderBy("moves", "asc")
          .limit(10)
          .get();

        const rows = [];
        let rank = 1;

        snap.forEach(doc => {
          const d = doc.data() || {};
          rows.push({
            rank,
            name: d.name || "???",
            time: Number.isFinite(d.time) ? d.time : 0,
            moves: Number.isFinite(d.moves) ? d.moves : 0,
            createdAt: d.createdAt?.toDate ? d.createdAt.toDate() : (d.createdAt || null)
          });
          rank++;
        });

        if(rows.length === 0){
          lbBody.innerHTML = `<tr><td colspan="5">No scores yet. Be the first! üòÑ</td></tr>`;
          return;
        }

        lbBody.innerHTML = rows.map((r, i) => {
          const cls = i === 0 ? "top1" : i === 1 ? "top2" : i === 2 ? "top3" : "";
          return `
            <tr class="${cls}">
              <td>${r.rank}</td>
              <td>${escapeHtml(r.name)}</td>
              <td>${r.time}s</td>
              <td>${r.moves}</td>
              <td>${r.createdAt ? formatDate(r.createdAt) : ""}</td>
            </tr>
          `;
        }).join("");

      }catch(e){
        console.warn(e);
        lbBody.innerHTML = `<tr><td colspan="5">Error loading leaderboard.</td></tr>`;
      }
    }

    async function submitScore(){
      if(!firebaseReady) return;
      if(!won) return;
      if(scoreSubmitted) return;
      if(isAnon) return;

      // use saved player name (but allow editing the box if you want)
      const entered = (nameInput.value || "").trim();
      const name = entered.length ? entered : playerName;

      if(name.length < 1 || name.length > 20){
        submitNote.textContent = "Name must be 1‚Äì20 characters.";
        return;
      }

      // if they typed a new name, persist it
      if(name !== playerName){
        setPlayerNamed(name);
      }

      const time = currentTimeSeconds();

      scoreSubmitted = true;
      updateSubmitNote(true);

      try{
        await db.collection(SCORES_COLLECTION).add({
          name,
          moves,
          time,
          winId,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        submitNote.textContent = "Submitted ‚úÖ Refreshing leaderboard‚Ä¶";
        await loadLeaderboard();
        submitNote.textContent = "Submitted ‚úÖ (Top 10 updated)";
      }catch(e){
        console.warn(e);
        scoreSubmitted = false;
        updateSubmitNote(true);
        submitNote.textContent = "Submit failed (Firebase rules/config). We‚Äôll fix it next.";
      }
    }

    function updateButtons(){
      btnNew.disabled = shuffling;
      btnReset.disabled = shuffling;
      btnStart.disabled = shuffling || gameStarted;
    }

    function goToArcadeMenu(){
      window.location.href = "../index.html";
    }

    // ----------------
    // Events
    // ----------------
    btnBackMenu.addEventListener("click", goToArcadeMenu);

    btnHow.addEventListener("click", () => openModal(howModal));
    howBack.addEventListener("click", () => closeModal(howModal));

    btnLeaderboard.addEventListener("click", async () => {
      openModal(lbModal);
      await loadLeaderboard();
      updateSubmitNote();
      if(!isAnon && won && !scoreSubmitted){
        setTimeout(() => nameInput.focus(), 60);
      }
    });
    lbBack.addEventListener("click", () => closeModal(lbModal));

    submitScoreBtn.addEventListener("click", submitScore);

    btnNew.addEventListener("click", () => {
      if(shuffling) return;
      newGame();
    });

    btnReset.addEventListener("click", () => {
      if(shuffling) return;
      stopTimer();
      buildSolvedBoardUsingCurrentImages();
    });

    btnStart.addEventListener("click", async () => {
      if(shuffling) return;
      stopTimer();
      buildSolvedBoardUsingCurrentImages();
      await shuffleFor3Seconds();
      updateSubmitNote();
    });

    howModal.addEventListener("click", (e) => { if(e.target === howModal) closeModal(howModal); });
    lbModal.addEventListener("click", (e) => { if(e.target === lbModal) closeModal(lbModal); });

    // Player modal events
    playerSaveBtn.addEventListener("click", () => {
      const n = (playerNameInput.value || "").trim();
      if(n.length < 1 || n.length > 20){
        playerNote.textContent = "Username must be 1‚Äì20 characters.";
        return;
      }
      setPlayerNamed(n);
      playerNote.textContent = "";
      closeModal(playerModal);
      // keep leaderboard name input in sync
      nameInput.value = playerName;
      updateSubmitNote();
    });

    playerAnonBtn.addEventListener("click", () => {
      setPlayerAnon();
      playerNote.textContent = "";
      closeModal(playerModal);
      updateSubmitNote();
    });

    changePlayerBtn.addEventListener("click", () => {
      // show modal again and prefill
      playerNameInput.value = isAnon ? "" : playerName;
      playerNote.textContent = "";
      openModal(playerModal);
      setTimeout(() => playerNameInput.focus(), 50);
    });

    playerModal.addEventListener("click", (e) => { if(e.target === playerModal) closeModal(playerModal); });

    // ----------------
    // Init
    // ----------------
    initFirebaseIfConfigured();
    loadPlayer();

    chosenImgs = pick4UniqueImages();
    buildSolvedBoardUsingCurrentImages();
    updateButtons();

    // ‚úÖ prompt once on first ever visit
    ensurePlayerChosen();
  </script>
</body>
</html>
